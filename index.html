<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Session Logoff – Audio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    #recordBtn, #sendBtn {
      padding: 15px 25px;
      margin: 10px;
      font-size: 18px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
    #preview {
      margin-top: 20px;
    }
    img.logo {
      max-width: 240px;
      margin-bottom: 20px;
    }
    #successToast {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 16px;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <img 
    class="logo" 
    src="https://inmotionwellnessstudio.com/wp-content/uploads/2025/05/logo__full_color-1-png.webp" 
    alt="InMotion Wellness Studio Logo"
  />

  <h2>Session Logoff – Audio</h2>
  <p id="sessionInfo"></p>

  <button id="recordBtn">Start recording</button>
  <button id="sendBtn" disabled>Send recording</button>

  <p id="status"></p>

  <audio id="preview" controls style="display:none;"></audio>

  <!-- Success toast -->
  <div id="successToast">✓ Recording sent successfully</div>

  <script>
    // Zapier webhook URL
    const ZAPIER_HOOK_URL = "https://hooks.zapier.com/hooks/catch/1249732/uzoc2m7/";

    // Read URL params
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("event_id");
    const trainerId = params.get("trainer_id");
    const clientName = params.get("client_name");

    const sessionInfo = document.getElementById("sessionInfo");
    sessionInfo.textContent = 
      `Event: ${eventId || "unknown"} | Specialist: ${trainerId || "unknown"}${clientName ? " | Client: " + clientName : ""}`;

    const recordBtn = document.getElementById("recordBtn");
    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");
    const preview = document.getElementById("preview");
    const successToast = document.getElementById("successToast");

    let mediaRecorder;
    let chunks = [];
    let audioBlob = null;

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = () => {
          audioBlob = new Blob(chunks, { type: "audio/webm" });
          preview.src = URL.createObjectURL(audioBlob);
          preview.style.display = "block";
          sendBtn.disabled = false;
          statusEl.textContent = "Recording complete. Review and send.";
        };

        mediaRecorder.start();
        statusEl.textContent = "Recording... tap again to stop.";

      } catch (err) {
        statusEl.textContent = "Microphone permission denied or unavailable.";
        console.error(err);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        statusEl.textContent = "Processing recording...";
      }
    }

    recordBtn.addEventListener("click", () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        startRecording();
        recordBtn.textContent = "Stop recording";
        sendBtn.disabled = true;
      } else if (mediaRecorder.state === "recording") {
        stopRecording();
        recordBtn.textContent = "Start recording";
      }
    });

    sendBtn.addEventListener("click", async () => {
      if (!audioBlob) {
        statusEl.textContent = "No recording to send.";
        return;
      }

      statusEl.textContent = "Uploading recording...";

      const formData = new FormData();
      formData.append("audio", audioBlob, "session_note.webm");
      formData.append("event_id", eventId || "");
      formData.append("trainer_id", trainerId || "");
      formData.append("client_name", clientName || "");
      formData.append("submitted_at", new Date().toISOString());

      try {
        const res = await fetch(ZAPIER_HOOK_URL, {
          method: "POST",
          body: formData
        });

        if (res.ok) {
          // Show toast
          successToast.style.display = "block";
          statusEl.textContent = "";

          sendBtn.disabled = true;
          recordBtn.disabled = true;

          // Auto-close (with fallback) after a short delay
          setTimeout(() => {
            window.close();
            window.location.href = "about:blank";
          }, 1200);

        } else {
          statusEl.textContent = "Upload failed. Try again or use the form.";
        }

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Network error while uploading.";
      }
    });
  </script>

</body>
</html>
